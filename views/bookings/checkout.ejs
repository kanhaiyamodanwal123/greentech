<%- include('../partials/header') %>

<div class="checkout-container">
  <div class="checkout-header">
    <h2>Complete Your Booking</h2>
    <p class="summary-text">Review your order details and choose a payment method to complete the checkout.</p>
  </div>

  <div class="order-summary-card">
    <h3>Order Summary</h3>
    <div class="order-item">
      <span class="item-label">Vehicle:</span>
      <span class="item-value"><%= vehicle.title %></span>
    </div>
    <div class="order-item">
      <span class="item-label">Price per Day:</span>
      <span class="item-value price" id="pricePerDay" data-price="<%= vehicle.pricePerDay %>">₹<%= vehicle.pricePerDay %></span>
    </div>
    <!-- New Duration Display -->
    <div class="order-item">
      <span class="item-label">Duration:</span>
      <span class="item-value" id="bookingDuration">0 Days</span>
    </div>
    <div class="order-total">
      <span class="total-label">Estimated Total:</span>
      <!-- ID added for JavaScript to target -->
      <span class="total-value price" id="estimatedTotal">₹<%= vehicle.pricePerDay %></span>
    </div>
  </div>

  <div class="booking-form-card">
    <h3>Booking Details</h3>
    <form action="/bookings/checkout/<%= vehicle._id %>" method="POST">
      <div class="form-group">
        <label for="startDate">Booking Start Date</label>
        <input type="date" name="startDate" id="startDate" required />
      </div>
      <div class="form-group">
        <label for="endDate">Booking End Date</label>
        <input type="date" name="endDate" id="endDate" required />
      </div>

      <div class="payment-section">
        <h3>Payment Method</h3>
        <div class="payment-option">
          <input type="radio" id="upiPayment" name="paymentMethod" value="upi" checked>
          <label for="upiPayment">Pay with UPI / QR Code</label>
        </div>
        
        <div class="upi-payment-details">
          <p class="scan-instruction">Scan the QR code below using any UPI app to pay.</p>
          <div class="qr-code-box">
            <img src="/uploads/AccountQRCodeAirtel Payments Bank Limited - 3777_DARK_THEME1010983026008868687.png" alt="UPI QR Code" class="qr-code-image" />
          </div>
          <p class="upi-id-info">Or pay to: kanhamod45@ybl</p>
        </div>

        <div class="utr-section">
          <p class="utr-instruction">After a successful payment, please enter the UTR / Transaction ID to confirm your booking.</p>
          <div class="form-group">
            <label for="utrNumber">UTR / Transaction ID</label>
            <input type="text" name="utrNumber" id="utrNumber" placeholder="Enter 12-digit UTR" required>
          </div>
        </div>
      </div>

      <button class="btn btn-primary confirm-booking-btn" type="submit">Confirm Booking</button>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const pricePerDayElement = document.getElementById('pricePerDay');
    const estimatedTotalElement = document.getElementById('estimatedTotal');
    const durationElement = document.getElementById('bookingDuration');

    // Get the base price from the EJS data attribute
    const pricePerDay = parseFloat(pricePerDayElement.dataset.price);

    // Set minimum date for start date to today
    const today = new Date().toISOString().split('T')[0];
    startDateInput.setAttribute('min', today);

    // Function to calculate and update the total price
    function updateTotalPrice() {
      const startDate = new Date(startDateInput.value);
      const endDate = new Date(endDateInput.value);

      if (isNaN(startDate) || isNaN(endDate) || startDate >= endDate) {
        // Handle invalid dates (or before selecting end date)
        estimatedTotalElement.textContent = `₹${pricePerDay.toFixed(2)}`;
        durationElement.textContent = '0 Days';
        return;
      }

      // 1. Calculate the difference in time
      // 86400000 ms = 1 day
      const timeDifference = endDate.getTime() - startDate.getTime();

      // 2. Convert difference to days (must be at least 1 day)
      let durationDays = Math.ceil(timeDifference / (1000 * 3600 * 24));
      
      // Ensure minimum duration is 1 day if dates are valid
      if (durationDays < 1 && startDateInput.value && endDateInput.value) {
          durationDays = 1; 
      }
      
      // 3. Calculate total amount
      const totalAmount = pricePerDay * durationDays;

      // 4. Update the display elements
      estimatedTotalElement.textContent = `₹${totalAmount.toFixed(2)}`;
      durationElement.textContent = `${durationDays} Day${durationDays !== 1 ? 's' : ''}`;
    }

    // Attach event listeners to both date inputs
    startDateInput.addEventListener('change', updateTotalPrice);
    endDateInput.addEventListener('change', updateTotalPrice);
    
    // Also, ensure the end date is always after the start date
    startDateInput.addEventListener('change', () => {
        endDateInput.setAttribute('min', startDateInput.value);
        if (endDateInput.value && endDateInput.value < startDateInput.value) {
            // Clear end date if it becomes invalid
            endDateInput.value = '';
        }
    });

  });
</script>

<%- include('../partials/footer') %>
